---
title: "DataSHIELD Aramdillo"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Using Armadillo to perform analysis with DataSHIELD}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# DataSHIELD Armadillo
When you start to use Aramdillo as a backend for DataSHIELD you can use the `DSMolgenisArmadillo` package for research purposes.

## Installation
The DataSHIELD Armadillo package is available on CRAN. You can install it by executing the following code-block:

```{r, eval = FALSE}
install.packages("DSMolgenisArmadillo")
```

Make sure you install the DataSHIELD client (`dsBaseClient`) to perform the actual analysis.

```{r}
# install the DataSHIELD client
install.packages("dsBaseClient", repos = "http://cran.datashield.org")
```

**Experimental versions**

If you are interested in using exeperimental versions you can use our own CRAN repository:

```{r, eval = FALSE}
# install experimental Armadillo client
install.packages("DSMolgenisArmadillo", repos = "https://registry.molgenis.org/repository/R")
```

Load the required libraries.

```{r}
# load the necessary packages
library(dsBaseClient)
library(DSMolgenisArmadillo)
```

You can determine which version of the DSMolgenisArmadillo you are running by executing the following code:

```{r}
dsGetInfo(armadillo())
```

## Usage
There is a default workflow in DataSHIELD to do analysis. There are several steps that you need to take.

- Login
- Assign data
- Transform data (if necessary)
- Performing the analysis

All of these components will be addressed.

### Login on DataSHIELD Armadillo
The login procedure consists of building a login dataframe and performing the login on the Armadillo server. The important part is to specify the driver. This should be `ArmadilloDriver`.

```{r}
# build the login dataframe
builder <- DSI::newDSLoginBuilder()
builder$append(server = "armadillo",
               url = "https://armadillo.dev.molgenis.org?workspace=GECKO/patient",
               user = "admin",
               password = "admin",
               token = "",
               table = "datashield.PATIENT",
               driver = "ArmadilloDriver")

# create login dataframe
logindata <- builder$build()

# login to the server
conns <- datashield.login(logins = logindata, assign = F)

# get connection information regarding the server
dsGetInfo(conns$armadillo)
```

### Assign data
To work with DataSHIELD you need to be able to query data. You can do this by assigning data in the Armadillo service.

```{r}
# assign data in the Armadillo service
datashield.assign.table(conns = conns,
                        table = "datashield.PATIENT",
                        symbol = "D",
                        variables = c("age", "name"))
```

You can inspect which symbols, or table references, that are created on the server.

```{r}
datashield.symbols(conns)

datashield.table_status(conns, "datashield.PATIENT")
```

#### Symbol assignment
For each of the tables assigned in the Aramdillo a symbol is created in each of the servers. 
You can remove the symbol from the workspace on the server by executing the following code:

```{r}
# list the current symbols
datashield.symbols(conns)
# remove the symbol
datashield.rm(conns = conns, "D")
# list the current symbols without the deleted one
datashield.symbols(conns)
```

You can assign values from tables to symbols, but hardcoded values as well.
```{r}
# assign random data to 'K'
datashield.assign.expr(conns = conns, symbol = "K", "c(10,50,100)")
# calculate the mean of 'K' to see that the assignment has worked
ds.mean("K", datasources = conns)
```

#### Table methods
When up assigned symbols in R you check which tables (`data.frame`'s) are available on the Armadillo.

```{r}
# assign the data again
datashield.assign.table(conns = conns, 
                        table = "datashield.PATIENT", 
                        symbol = "D")

# list all tables
dsListTables(conns$armadillo)

# check if table exists
dsHasTable(conns$armadillo, "datashield.PATIENT")
dsHasTable(conns$armadillo, "datashield.NOTPATIENT")
```

### Transforming data
In general you need 2 methods to work with data that is stored in longformat, the `reshape` and `merge` functions in DataSHIELD. You can reshape data with the Aramdillo to transform data from [wide-format to long-format](https://www.theanalysisfactor.com/wide-and-long-data/) and viceversa. 

You can do this using the `ds.reshape` function:

```{r, eval = FALSE}
# assign the repeated data to reshape
datashield.assign.table(conns = conns,
                        table = "datashield.PATIENT_REP",
                        symbol = "yearlyrep")

# reshape the data for the wide-format variables (yearlyrep)
ds.reShape(data.name='yearlyrep',
           timevar.name = 'year',
           idvar.name = 'id',
           v.names=c("height", "weight"),
           direction = 'wide',
           newobj = "PATIENTREPwide",
           datasources = conns
)

# show the reshaped columns of the new dataframe
ds.colnames("PATIENTREPwide", datasources = conns)
```

When you reshaped the data you often need to merge your dataframe with others to get your analysis dataframe. You can do this using the `ds.merge` function:

```{r, eval = FALSE}
# assign the non repeated data to merge with
datashield.assign.table(conns = conns,
                        table = "datashield.PATIENT",
                        symbol = "nonrep")

ds.merge(x.name = 'nonrep',
         y.name = 'PATIENTREPwide',
         by.x.names = 'id',
         by.y.names = 'id',
         newobj = 'mergedvars',
         datasources = conns
)

ds.colnames("mergedvars")
```

### Performing analysis
When you finished the analysis dataframe, you can perform the actual analysis. You can use a wide variety of functions. The example below is showing the `glm`.

```{r, eval = FALSE}
ds.glm(formula = 'height.1~height.3', 
       data = 'mergedvars', 
       family = 'binomial', 
       datasources = conns)
```

### Using workspaces
To store the assigned data in the Armadillo service, you can use workspaces to make sure a certain state of the data is maintained on the service.

Saving the workspaces can be done during logout or at runtime.

```{r}
# reassign data from a Armadillo table
datashield.assign.table(conns = conns,
                        table = "datashield.PATIENT",
                        symbol = "J",
                        variables = c("age", "name"))

# save the workspace duringg logout
datashield.logout(conns, save = "my-workspace")

# restore workspace during logging in
conns <- datashield.login(logins = logindata, 
                          assign = FALSE, 
                          restore = "my-workspace")

# check if the workspace is restored correctly
# should contain 'J'
datashield.symbols(conns)

# save workspace at runtime
datashield.workspace_save(conns, "my-workspace-version-2")
```

You can overwrite workspaces using the same name again when saving the workspace.

```{r}
# make sure we start with an empty workspace
datashield.logout(conns)
conns <- datashield.login(logins = logindata)

# assign data to make sure something is in the workspace
datashield.assign.table(conns = conns, 
                        table = "datashield.PATIENT", 
                        symbol = "H")

datashield.workspace_save(conns, "my-workspace-overwritten")
datashield.workspace_save(conns, "my-workspace-overwritten")
```

You can list the workspaces as well.

```{r}
# list all workspaces for this user
datashield.workspaces(conns$armadillo)
```

Remove workspaces.

```{r}
# create a new workspace 
datashield.workspace_rm(conns, "my-workspace-overwritten")
# list the workspaces to make sure the overwritten one is deleted
datashield.workspaces(conns)
```

### Viewing available methods and packages
In DataSHIELD you can use a variety of methods and packages. To check which are avaiable you can execute the following code:

#### Available packages (serverside)
The available packages displayed by the method, are the serverside R-packages. Which means the packages available on the Armadillo.

```{r}
# check packages
conns <- datashield.login(logins = logindata, assign = F)
dsListPackages(conns$armadillo)
```

#### Available methods (clientside)
These are the available methods on the Armadillo server.

```{r}
# check methods
datashield.methods(conns = conns, type = "aggregate")
datashield.methods(conns = conns, type = "assign")
```





